<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>番茄花果识别</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <h1>番茄花果识别</h1>
    <p>上传一张图片，模型会预测番茄花与果实，并给出数量统计。</p>
  </header>

  <main>
    <section class="card">
      <div class="tabs">
        <button class="tab active" data-tab="upload-tab">上传图片</button>
        <button class="tab" data-tab="camera-tab">摄像头拍摄</button>
      </div>
      <div class="tab-content" id="upload-tab">
        <form method="POST" enctype="multipart/form-data">
          <div class="field">
            <label class="upload-label">
              <span>选择图片</span>
              <input id="file-input" type="file" name="image" accept="image/*" required>
            </label>
          </div>
          <div class="field">
            <label for="model_path">选择模型</label>
            <select name="model_path" id="model_path" required>
              {% for m in available_models %}
                <option value="{{ m.name }}" {% if selected_model and selected_model == m.name %}selected{% endif %}>{{ m.name }}</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit">开始识别</button>
        </form>
        {% if error %}
          <p class="error">{{ error }}</p>
        {% endif %}
      </div>

      <div class="tab-content hidden" id="camera-tab">
        <div class="field">
          <label for="camera-model">选择模型</label>
          <select id="camera-model">
            {% for m in available_models %}
              <option value="{{ m.name }}" {% if selected_model and selected_model == m.name %}selected{% endif %}>{{ m.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="camera-box">
          <video id="video" autoplay playsinline></video>
          <canvas id="canvas" class="hidden"></canvas>
          <div class="camera-actions">
            <button id="start-camera" type="button">打开摄像头</button>
            <button id="capture" type="button">拍照并识别</button>
          </div>
          <p id="camera-error" class="error"></p>
        </div>
      </div>
    </section>

    <section class="results">
      <div class="card">
        <h2>原图</h2>
        <div class="image-box">
          <img id="original-image" src="{{ original_url or '' }}" alt="用户上传图片" class="{% if not original_url %}hidden{% endif %}">
          <div id="original-placeholder" class="placeholder {% if original_url %}hidden{% endif %}">上传后原图会显示在这里</div>
        </div>
      </div>
      <div class="card">
        <h2>预测结果</h2>
        <div class="image-box">
          <img id="prediction-image" src="{{ prediction_url or '' }}" alt="模型预测图片" class="{% if not prediction_url %}hidden{% endif %}">
          <div id="prediction-placeholder" class="placeholder {% if prediction_url %}hidden{% endif %}">预测结果会显示在这里</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>识别统计</h2>
      <div id="counts" class="counts">
        {% if counts %}
          {% for name, total in counts.items() %}
            <div class="count-row">
              <span>{{ name }}</span>
              <span class="badge">{{ total }}</span>
            </div>
          {% endfor %}
        {% else %}
          <div class="placeholder inline">暂无统计数据</div>
        {% endif %}
      </div>
    </section>
  </main>
  <script>
    const fileInput = document.getElementById('file-input');
    const originalImage = document.getElementById('original-image');
    const originalPlaceholder = document.getElementById('original-placeholder');
    const predictionImage = document.getElementById('prediction-image');
    const predictionPlaceholder = document.getElementById('prediction-placeholder');
    const countsContainer = document.getElementById('counts');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startCameraBtn = document.getElementById('start-camera');
    const captureBtn = document.getElementById('capture');
    const cameraError = document.getElementById('camera-error');
    const cameraModelSelect = document.getElementById('camera-model');
    let stream = null;

    fileInput.addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      originalImage.src = url;
      originalImage.classList.remove('hidden');
      originalPlaceholder.classList.add('hidden');

      // Reset prediction image and counts when a new file is chosen
      predictionImage.src = '';
      predictionImage.classList.add('hidden');
      predictionPlaceholder.classList.remove('hidden');
      if (countsContainer) {
        countsContainer.innerHTML = '<div class="placeholder inline">等待识别结果...</div>';
      }
    });

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        tabContents.forEach(c => c.classList.add('hidden'));
        document.getElementById(tab.dataset.tab).classList.remove('hidden');
      });
    });

    async function startCamera() {
      try {
        if (stream) return;
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        cameraError.textContent = '';
      } catch (err) {
        cameraError.textContent = '无法访问摄像头，请检查权限或设备。';
      }
    }

    async function captureAndPredict() {
      if (!stream) {
        cameraError.textContent = '请先打开摄像头。';
        return;
      }
      const context = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(async (blob) => {
        if (!blob) return;
        const formData = new FormData();
        formData.append('image', blob, 'capture.png');
        formData.append('model_path', cameraModelSelect.value);

        // Show captured frame as original preview
        const snapshotUrl = URL.createObjectURL(blob);
        originalImage.src = snapshotUrl;
        originalImage.classList.remove('hidden');
        originalPlaceholder.classList.add('hidden');
        predictionImage.src = '';
        predictionImage.classList.add('hidden');
        predictionPlaceholder.classList.remove('hidden');
        countsContainer.innerHTML = '<div class="placeholder inline">识别中...</div>';

        try {
          const response = await fetch('/predict', { method: 'POST', body: formData });
          const data = await response.json();
          if (!response.ok || data.error) {
            cameraError.textContent = data.error || '识别失败';
            countsContainer.innerHTML = '<div class="placeholder inline">识别失败</div>';
            return;
          }
          predictionImage.src = data.prediction_url;
          predictionImage.classList.remove('hidden');
          predictionPlaceholder.classList.add('hidden');
          countsContainer.innerHTML = '';
          Object.entries(data.counts || {}).forEach(([name, total]) => {
            const row = document.createElement('div');
            row.className = 'count-row';
            row.innerHTML = `<span>${name}</span><span class="badge">${total}</span>`;
            countsContainer.appendChild(row);
          });
          cameraError.textContent = '';
        } catch (err) {
          cameraError.textContent = '识别请求失败，请重试。';
          countsContainer.innerHTML = '<div class="placeholder inline">识别失败</div>';
        }
      }, 'image/png');
    }

    startCameraBtn.addEventListener('click', startCamera);
    captureBtn.addEventListener('click', captureAndPredict);
  </script>
</body>
</html>
