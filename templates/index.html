<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>番茄花果识别</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <h1>番茄花果识别</h1>
    <p>上传图片或手机拍照，获取番茄花果识别结果与数量统计。</p>
  </header>

  <main class="layout">
    <section class="panel card">
      <div class="tabs">
        <button class="tab active" data-tab="upload">上传图片</button>
        <button class="tab" data-tab="camera">拍照上传图片</button>
      </div>

      <div class="tab-content" id="tab-upload">
        <form method="POST" enctype="multipart/form-data">
          <div class="field">
            <label class="upload-label">
              <span>选择图片</span>
              <input id="file-input" type="file" name="image" accept="image/*">
            </label>
          </div>
          <div class="field">
            <label for="model_path">选择模型</label>
            <select name="model_path" id="model_path" required>
              {% for m in available_models %}
                <option value="{{ m.name }}" {% if selected_model and selected_model == m.name %}selected{% endif %}>{{ m.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="field slider-field">
            <label class="slider-label" for="confidence">
              <span>置信度阈值</span>
              <input type="number" id="confidence-value" class="slider-value-input" min="0" max="1" step="0.01" value="{{ "%.2f"|format(confidence|default(0.25)) }}">
            </label>
            <input type="range" name="confidence" id="confidence" min="0" max="1" step="0.01" value="{{ "%.2f"|format(confidence|default(0.25)) }}">
          </div>
          <div class="field slider-field">
            <label class="slider-label" for="iou">
              <span>IOU 阈值</span>
              <input type="number" id="iou-value" class="slider-value-input" min="0" max="1" step="0.01" value="{{ "%.2f"|format(iou|default(0.7)) }}">
            </label>
            <input type="range" name="iou" id="iou" min="0" max="1" step="0.01" value="{{ "%.2f"|format(iou|default(0.7)) }}">
          </div>
          <input type="hidden" name="existing_image" id="existing_image" value="{{ image_token or '' }}">
          <button type="submit">开始识别</button>
          <p id="upload-status" class="status"></p>
        </form>
        {% if error %}
          <p class="error">{{ error }}</p>
        {% endif %}
      </div>

      <div class="tab-content hidden" id="tab-camera">
        <div class="field">
          <label for="camera-model">选择模型</label>
          <select id="camera-model">
            {% for m in available_models %}
              <option value="{{ m.name }}" {% if selected_model and selected_model == m.name %}selected{% endif %}>{{ m.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="camera-box">
          <div class="field">
            <label class="upload-label">
              <span>打开手机摄像头拍照</span>
              <input id="capture-input" type="file" accept="image/*" capture="environment">
            </label>
            <small class="hint">在手机端会直接调起摄像头，拍完自动上传识别。</small>
          </div>
          <div class="field slider-field">
            <label class="slider-label" for="camera-confidence">
              <span>置信度阈值</span>
              <input type="number" id="camera-confidence-value" class="slider-value-input" min="0" max="1" step="0.01" value="{{ "%.2f"|format(confidence|default(0.25)) }}">
            </label>
            <input type="range" id="camera-confidence" min="0" max="1" step="0.01" value="{{ "%.2f"|format(confidence|default(0.25)) }}">
          </div>
          <div class="field slider-field">
            <label class="slider-label" for="camera-iou">
              <span>IOU 阈值</span>
              <input type="number" id="camera-iou-value" class="slider-value-input" min="0" max="1" step="0.01" value="{{ "%.2f"|format(iou|default(0.7)) }}">
            </label>
            <input type="range" id="camera-iou" min="0" max="1" step="0.01" value="{{ "%.2f"|format(iou|default(0.7)) }}">
          </div>
          <button id="camera-run" type="button">开始识别</button>
          <p id="camera-status" class="status"></p>
          <p id="camera-error" class="error"></p>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="card full-width">
        <h2>原图</h2>
        <div class="image-box">
          <img id="original-image" src="{{ original_url or '' }}" alt="用户上传图片" class="{% if not original_url %}hidden{% endif %}">
          <div id="original-placeholder" class="placeholder {% if original_url %}hidden{% endif %}">原图会显示在这里</div>
        </div>
      </div>
      <div class="card full-width">
        <h2>预测结果</h2>
        <div class="image-box">
          <img id="prediction-image" src="{{ prediction_url or '' }}" alt="模型预测图片" class="{% if not prediction_url %}hidden{% endif %}">
          <div id="prediction-placeholder" class="placeholder {% if prediction_url %}hidden{% endif %}">预测结果会显示在这里</div>
        </div>
      </div>
    </section>

    <section class="card stats">
      <div class="card-header">
        <h2>识别统计</h2>
        <button id="clear-cache" type="button" class="ghost">清理历史缓存</button>
      </div>
      <div id="counts" class="counts">
        {% if counts %}
          {% for name, total in counts.items() %}
            <div class="count-row">
              <span>{{ name }}</span>
              <span class="badge">{{ total }}</span>
            </div>
          {% endfor %}
        {% else %}
          <div class="placeholder inline">暂无统计数据</div>
        {% endif %}
      </div>
      <p id="cache-status" class="status"></p>
    </section>
  </main>
  <script>
    const fileInput = document.getElementById('file-input');
    const originalImage = document.getElementById('original-image');
    const originalPlaceholder = document.getElementById('original-placeholder');
    const predictionImage = document.getElementById('prediction-image');
    const predictionPlaceholder = document.getElementById('prediction-placeholder');
    const countsContainer = document.getElementById('counts');
    const tabs = document.querySelectorAll('.tab');
    const captureInput = document.getElementById('capture-input');
    const cameraRunBtn = document.getElementById('camera-run');
    const cameraError = document.getElementById('camera-error');
    const cameraModelSelect = document.getElementById('camera-model');
    const confidenceInput = document.getElementById('confidence');
    const confidenceValue = document.getElementById('confidence-value');
    const iouInput = document.getElementById('iou');
    const iouValue = document.getElementById('iou-value');
    const cameraConfidenceInput = document.getElementById('camera-confidence');
    const cameraConfidenceValue = document.getElementById('camera-confidence-value');
    const cameraIouInput = document.getElementById('camera-iou');
    const cameraIouValue = document.getElementById('camera-iou-value');
    const clearCacheBtn = document.getElementById('clear-cache');
    const cacheStatus = document.getElementById('cache-status');
    const existingImageInput = document.getElementById('existing_image');
    const uploadForm = document.querySelector('#tab-upload form');
    const uploadStatus = document.getElementById('upload-status');
    const cameraStatus = document.getElementById('camera-status');
    let activeTab = 'upload';
    let cameraFile = null;

    const initialCounts = {{ counts|tojson|default('null') }} || {};
    const states = {
      upload: { original: {{ (original_url or '')|tojson }}, prediction: {{ (prediction_url or '')|tojson }}, counts: initialCounts, message: null },
      camera: { original: '', prediction: '', counts: {}, message: null },
    };

    function setRangeFill(rangeEl) {
      if (!rangeEl) return;
      const min = Number(rangeEl.min || 0);
      const max = Number(rangeEl.max || 1);
      const val = Number(rangeEl.value || min);
      const percent = ((val - min) / (max - min || 1)) * 100;
      rangeEl.style.setProperty('--slider-pct', `${percent}%`);
    }

    function bindSliderPair(rangeEl, numberEl) {
      if (!rangeEl || !numberEl) return;
      const clamp = (val) => {
        const parsed = Number.parseFloat(val);
        if (Number.isNaN(parsed)) return Math.min(1, Math.max(0, Number.parseFloat(rangeEl.value) || 0));
        return Math.min(1, Math.max(0, parsed));
      };
      const sync = (val) => {
        const clamped = clamp(val);
        rangeEl.value = clamped.toFixed(2);
        numberEl.value = clamped.toFixed(2);
        setRangeFill(rangeEl);
      };
      rangeEl.addEventListener('input', () => sync(rangeEl.value));
      numberEl.addEventListener('input', () => sync(numberEl.value));
      sync(numberEl.value || rangeEl.value);
    }

    function renderCounts(counts, message) {
      countsContainer.innerHTML = '';
      if (message) {
        countsContainer.innerHTML = `<div class="placeholder inline">${message}</div>`;
        return;
      }
      const entries = Object.entries(counts || {});
      if (!entries.length) {
        countsContainer.innerHTML = '<div class="placeholder inline">暂无统计数据</div>';
        return;
      }
      entries.forEach(([name, total]) => {
        const row = document.createElement('div');
        row.className = 'count-row';
        row.innerHTML = `<span>${name}</span><span class="badge">${total}</span>`;
        countsContainer.appendChild(row);
      });
    }

    function applyState(tab) {
      const state = states[tab] || { original: '', prediction: '', counts: {}, message: null };
      if (state.original) {
        originalImage.src = state.original;
        originalImage.classList.remove('hidden');
        originalPlaceholder.classList.add('hidden');
      } else {
        originalImage.src = '';
        originalImage.classList.add('hidden');
        originalPlaceholder.classList.remove('hidden');
      }

      if (state.prediction) {
        predictionImage.src = state.prediction;
        predictionImage.classList.remove('hidden');
        predictionPlaceholder.classList.add('hidden');
      } else {
        predictionImage.src = '';
        predictionImage.classList.add('hidden');
        predictionPlaceholder.classList.remove('hidden');
      }

      renderCounts(state.counts, state.message);
    }

    function setState(tab, data) {
      states[tab] = { ...states[tab], ...data };
      if (activeTab === tab) {
        applyState(tab);
      }
    }

    bindSliderPair(confidenceInput, confidenceValue);
    bindSliderPair(iouInput, iouValue);
    bindSliderPair(cameraConfidenceInput, cameraConfidenceValue);
    bindSliderPair(cameraIouInput, cameraIouValue);

    fileInput.addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      if (!file) return;
      if (existingImageInput) existingImageInput.value = '';
      const url = URL.createObjectURL(file);
      setState('upload', { original: url, prediction: '', counts: {}, message: '等待识别结果...' });
    });

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`tab-${tab.dataset.tab}`).classList.remove('hidden');
        activeTab = tab.dataset.tab;
        applyState(activeTab);
      });
    });

    async function predictBlob(tabKey, blob, modelValue, thresholds, filename) {
      const formData = new FormData();
      formData.append('image', blob, filename || 'capture.jpg');
      formData.append('model_path', modelValue);
      if (thresholds?.confidence !== undefined) {
        formData.append('confidence', thresholds.confidence);
      }
      if (thresholds?.iou !== undefined) {
        formData.append('iou', thresholds.iou);
      }

      setState(tabKey, { prediction: '', counts: {}, message: '识别中...' });
      if (cameraStatus) cameraStatus.textContent = '正在识别...';

      try {
        const response = await fetch('/predict', { method: 'POST', body: formData });
        const data = await response.json();
        if (!response.ok || data.error) {
          const errMsg = data.error || '识别失败';
          cameraError.textContent = errMsg;
          setState(tabKey, { prediction: '', counts: {}, message: errMsg });
          return;
        }
        setState(tabKey, { original: data.original_url, prediction: data.prediction_url, counts: data.counts || {}, message: null });
        cameraError.textContent = '';
      } catch (err) {
        cameraError.textContent = '识别请求失败，请重试。';
        setState(tabKey, { prediction: '', counts: {}, message: '识别失败' });
      } finally {
        if (cameraStatus) cameraStatus.textContent = '';
      }
    }

    captureInput.addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      if (!file) return;
      cameraFile = file;
      const previewUrl = URL.createObjectURL(file);
      setState('camera', { original: previewUrl, prediction: '', counts: {}, message: '准备识别，请选择模型后点击开始识别' });
      cameraError.textContent = '';
    });

    cameraRunBtn.addEventListener('click', () => {
      if (!cameraFile) {
        cameraError.textContent = '请先拍照或选择图片。';
        return;
      }
      predictBlob(
        'camera',
        cameraFile,
        cameraModelSelect.value,
        { confidence: cameraConfidenceInput?.value, iou: cameraIouInput?.value },
        cameraFile.name || 'capture.jpg'
      );
    });

    if (uploadForm) {
      uploadForm.addEventListener('submit', () => {
        if (uploadStatus) uploadStatus.textContent = '正在识别...';
      });
    }

    function collectKeepFiles() {
      const names = new Set();
      Object.values(states).forEach(state => {
        [state.original, state.prediction].forEach(url => {
          if (!url) return;
          const parts = url.split('/');
          const name = parts[parts.length - 1];
          if (name) names.add(name);
        });
      });
      return Array.from(names);
    }

    async function clearCache() {
      const code = prompt('请输入安全码以清理缓存：');
      if (code !== '888') {
        cacheStatus.textContent = '安全码错误，未清理缓存。';
        return;
      }
      const keep = collectKeepFiles();
      cacheStatus.textContent = '清理中...';
      try {
        const response = await fetch('/clear_cache', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ keep }),
        });
        const data = await response.json();
        if (!response.ok) throw new Error('清理失败');
        cacheStatus.textContent = `已清理 ${data.removed.length} 个文件；当前图片已保留。`;
      } catch (err) {
        cacheStatus.textContent = '清理缓存失败，请重试。';
      }
    }

    clearCacheBtn.addEventListener('click', clearCache);

    applyState(activeTab);
  </script>
</body>
</html>
